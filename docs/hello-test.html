<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="A future work" />
        <title>
      <span
        data-editable="true"
        data-section="title"
        data-path="hello test.txt"
        data-foldered="undefined"
      >hello test</span>
     / A Blog website</title>
        <link rel="stylesheet" href="/assets/default/style/style.css">
    </head>

    <body>

        <div class="container">
            <nav class="topbar">
                <h1 class="site-title" id="dark-toggle">A Blog website</h1>
            </nav>

            <main class="content">
                <article class="post post--text">
                    <header class="post-header">
                        <h2>
      <span
        data-editable="true"
        data-section="title"
        data-path="hello test.txt"
        data-foldered="undefined"
      >hello test</span>
    </h2>
                    </header>
                    <section class="post-content">
      <div
        data-editable="true"
        data-section="content"
        data-path="hello test.txt"
        data-foldered="undefined"
      ><p>hello</p>
<p>trying txt</p>
</div>
                        </section>
                    <footer class="post-footer">
                        <section class="post-footer-section">
                            <table class="post-metadata">
                                <tr class="post-metadata-date">
                                    <td>Published at</td>
                                    <td>Nov 12, 2022</td>
                                </tr>
                                <tr class="post-metadata-category">
                                    <td>Category</td>
                                    <td><a href="/uncategorized">Uncategorized</a></td>
                                </tr>
                            </table>
                        </section>
                            <a href="/son-sey.html">&laquo; Son Şey</a>
                            <a href="/ole-bole.html">Öle böle &raquo;</a>
                    </footer>
                </article>
            </main>
        </div>

        <svg class="icon-symbols">
            <symbol id="search-icon" viewBox="0 0 512 512">
            <path d="M344.5 298c15-23.6 23.8-51.6 23.8-81.7 0-84.1-68.1-152.3-152.1-152.3C132.1 64 64 132.2 64 216.3c0 84.1 68.1 152.3 152.1 152.3 30.5 0 58.9-9 82.7-24.4l6.9-4.8L414.3 448l33.7-34.3-108.5-108.6 5-7.1zm-43.1-166.8c22.7 22.7 35.2 52.9 35.2 85s-12.5 62.3-35.2 85c-22.7 22.7-52.9 35.2-85 35.2s-62.3-12.5-85-35.2c-22.7-22.7-35.2-52.9-35.2-85s12.5-62.3 35.2-85c22.7-22.7 52.9-35.2 85-35.2s62.3 12.5 85 35.2z"/>
            </symbol>
            <symbol id="music-icon" viewBox="0 0 64 64">
            <path d="M23.727 16.403v24.134a8.296 8.296 0 00-4.35-1.233c-4.612 0-8.353 3.74-8.353 8.349a8.354 8.354 0 008.353 8.354c4.61 0 8.349-3.739 8.35-8.352V25.151l21.25-6.109V33.33a8.296 8.296 0 00-4.35-1.233c-4.614 0-8.353 3.739-8.353 8.348a8.354 8.354 0 008.353 8.354c4.344 0 7.914-3.325 8.31-7.57h.04V7.993l-29.25 8.41z"/>
            </symbol>
            <symbol id="date-icon" viewBox="0 0 24 24">
            <path clip-rule="evenodd" d="M12 0C5.375 0 .003 5.373.003 12S5.375 24 12 24c6.626 0 11.997-5.373 11.997-12S18.626 0 12 0zm4.412 16.709l-.35.35a.803.803 0 01-1.088.029l-4.52-3.955c-.308-.275-.541-.838-.521-1.25l.419-7.134a.801.801 0 01.79-.749h.493c.413 0 .767.336.787.748l.343 5.934c.021.413.262 1 .535 1.309l3.144 3.628a.807.807 0 01-.032 1.09z" fill-rule="evenodd"/>
            <path d="M430.1 192H81.9c-17.7 0-18.6 9.2-17.6 20.5l13 183c.9 11.2 3.5 20.5 21.1 20.5h316.2c18 0 20.1-9.2 21.1-20.5l12.1-185.3c.9-11.2 0-18.2-17.7-18.2zM426.2 143.3c-.5-12.4-4.5-15.3-15.1-15.3H267.9c-21.8 0-24.4.3-40.9-17.4-13.7-14.8-8.3-14.6-36.6-14.6h-75.3c-17.4 0-23.6-1.5-25.2 16.6-1.5 16.7-5 57.2-5.5 63.4h343.4l-1.6-32.7z"/>
            <path clip-rule="evenodd" d="M12 0C5.375 0 .003 5.373.003 12S5.375 24 12 24c6.626 0 11.997-5.373 11.997-12S18.626 0 12 0zm4.412 16.709l-.35.35a.803.803 0 01-1.088.029l-4.52-3.955c-.308-.275-.541-.838-.521-1.25l.419-7.134a.801.801 0 01.79-.749h.493c.413 0 .767.336.787.748l.343 5.934c.021.413.262 1 .535 1.309l3.144 3.628a.807.807 0 01-.032 1.09z" fill-rule="evenodd"/>
            </symbol>
            <symbol id="category-icon" viewBox="0 0 100 80">
            <path d="M95.351 25h-90.7C.047 25-.183 27.241.067 29.979L4.194 75.02c.25 2.739.899 4.98 5.496 4.98h80.621c4.688 0 5.244-2.241 5.494-4.979l4.127-45.041c.251-2.739.022-4.98-4.581-4.98zm-3.329-11c-.555-2.2-3.275-4-6.047-4H51.903c-2.771 0-6.645-1.588-8.607-3.528l-2.979-2.943C38.354 1.588 34.481 0 31.71 0H15.431c-2.771 0-5.289 2.236-5.594 4.97L8.376 18H93.03l-1.008-4z"/>
            </symbol>
            <symbol id="tag-icon" viewBox="0 0 500 500">
            <path clip-rule="evenodd" d="M56.629 379.2c-14.09 14.071-14.09 36.975 0 51.055 14.08 14.087 36.981 14.087 50.965 0l10.177-10.08 42.438 42.428a18.413 18.413 0 0026.155 0l63.244-63.244a18.415 18.415 0 000-26.157l-42.429-42.427 75.586-75.682c16.174 8.357 34.61 13.075 54.059 13.075 65.234 0 118.111-52.869 118.111-118.109 0-65.232-52.877-118.111-118.111-118.111-65.238 0-118.11 52.879-118.11 118.111 0 19.449 4.721 37.886 13.077 54.06L56.629 379.2zm234.767-229.141c0-25.075 20.354-45.429 45.427-45.429 25.076 0 45.426 20.354 45.426 45.429s-20.35 45.426-45.426 45.426c-25.072 0-45.427-20.352-45.427-45.426z" fill-rule="evenodd"/>
            </symbol>
        </svg>

        <template id="date-icon-tmpl">
            <svg class="date-icon">
                <use xlink:href="#date-icon"></use>
            </svg>
        </template>

        <template id="category-icon-tmpl">
            <svg class="category-icon">
                <use xlink:href="#category-icon"></use>
            </svg>
        </template>

        <template id="tag-icon-tmpl">
            <svg class="tag-icon">
                <use xlink:href="#tag-icon"></use>
            </svg>
        </template>

        <template id="music-list-icon-tmpl">
            <svg class="music-icon post-music-list-icon">
                <use xlink:href="#music-icon"></use>
            </svg>
        </template>


        <script type="text/javascript" src="/assets/default/scripts/base.js"></script>
        <script type="text/javascript" src="/assets/default/scripts/text-post.js"></script>
    </body>

</html>
<template id="editor-tmpl">
  <div class="writ-editor">
    <div class="checkbox-control">
      <input type="checkbox" class="checkbox-input" id="edit-mode" />
      <label for="edit-mode" class="checkbox-label">
        Edit mode
      </label>
    </div>
    <button type="button" id="rebuild-btn">Rebuild</button>
    <button type="button" id="save-btn">Save</button>
    <div class="unsaved-changes">
      <h3>Unsaved changes:</h3>
      <ul id="unsaved-changes-list" class="unsaved-changes-list"></ul>
    </div>
  </div>
</template>

<style type="text/css">
:root {
  --editor-height: 36px;
}

body {
  margin-top: var(--editor-height);
}

.writ-editor {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: var(--editor-height);
  background: #fffa;
  backdrop-filter: blur(5px);
  transition: all .5s;
}

.writ-editor .checkbox-control {
  --padding: 0.25rem;
  padding: var(--padding);
  position: relative;
  display: inline-flex;
}

.writ-editor .checkbox-control .checkbox-input {
  margin: 0;
  position: absolute;
  top: 50%;
  left: calc(var(--padding) + 0.5rem);
  z-index: 1;
  transform: translateY(-55%);
}

.writ-editor .checkbox-control .checkbox-label {
  padding: 0.5em 0.5em 0.4em 1.75em;
  font: normal 14px/1 helvetica, arial, sans-serif;
  background: hotpink;
  border-radius: 5px;
}

.writ-editor .checkbox-control :checked + .checkbox-label {
  background: yellow;
}

.writ-editor .checkbox-control .checkbox-input {
  margin: 0;
  align-self: flex-start;
}

.writ-editor .unsaved-changes {
  max-height: initial;
  overflow: visible;
  opacity: 1;
  transform: scale(1, 1);
}

.writ-editor .unsaved-changes {
  max-height: 0;
  overflow: hidden;
  opacity: 0;
  transform: scale(1, 0);
  transition: all .5s;
}

body.edit-mode [data-editable="true"] {
  --outline-offset: 7px;
  --outline-width: 3px;
  --outline-color: gainsboro;
  box-shadow:
    0 0 0 var(--outline-offset) white,
    0 0 0 calc( var(--outline-offset) + var(--outline-width) ) var(--outline-color);
  outline-offset: var(--outline-offset);
  border-radius: 1px;
  transition: all .3s;
}

body:not(.edit-mode) [data-editable="true"][data-section="summary"] {
  opacity: 0;
  position: absolute;
}

body.edit-mode [data-editable="true"][data-section="summary"] {
  --summary-color: gainsboro;
  position: relative;
  display: inline-block;
  width: 100%;
  height: 1px;
  margin: 0.5rem 0;
  padding: 1rem 0;
  cursor: ns-resize;
  background: var(--summary-color);
  transform: scaleX(0.3);
  opacity: 1;
  box-shadow:
    inset 0 calc(1rem - 1px) 0 white,
    inset 0 -1rem 0 white;
}

body.edit-mode [data-editable="true"][data-section="summary"]:hover {
  box-shadow:
    inset 0 0.8rem 0 white,
    inset 0 -0.8rem 0 white;
}

body.edit-mode [data-editable="true"]:hover {
  --outline-color: deepskyblue;
}

body.edit-mode [data-editable="true"]:hover [data-section="summary"]{
  --summary-color: deepskyblue;
}

body.edit-mode [data-editable="true"]:focus-within {
  --outline-color: transparent;
  --outline-offset: 1px;
}

body.edit-mode [data-editable="true"]:focus-within [data-section="summary"] {}
</style>

<script type="text/javascript">
  const query = document.querySelector.bind(document)
  const queryAll = document.querySelectorAll.bind(document)

  const editorTemplate = query('#editor-tmpl')
  const editorElement = editorTemplate.content.firstElementChild
  const unsavedChangesList = editorElement.querySelector('#unsaved-changes-list')

  const rebuild = () => {
    return fetch('/cms/refresh')
  }

  const Post = {
    updateContent(path, content) {
      return fetch(`/cms/post`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          content,
          path
        })
      })
    },

    updateTitle(path, title, foldered) {
      return fetch(`/cms/post`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title,
          updateUrl: true,
          path,
          foldered
        })
      })
    }
  }

  const findParent = (element, selector) => {
    if (element === document.body) {
      return null
    }
    const el = document.createElement('div')
    el.innerHTML = element.parentElement.outerHTML
    if (el.querySelector(selector)) {
      return element.parentElement
    }
    return findParent(element.parentElement, selector)
  }

  const omit = (object, keyToOmit) => {
    const keys = Object.keys(object)
    const restKeys = keys.filter(k => k !== keyToOmit)
    const restObject = restKeys.reduce((obj, key) => {
      return {
        ...obj,
        [key]: object[key]
      }
    }, {})
    return restObject
  }

  const restoreSeeMore = (content) => {
    const el = document.createElement('div')
    el.innerHTML = content
    const seeMore = el.querySelector('[data-section="summary"]')
    const parentNode = seeMore.parentNode
    const grandParentNode = parentNode.parentNode
    if (grandParentNode && !grandParentNode.querySelector('[data-section="content"]')) {
      const isFirst = !seeMore.previousSibling
      const isOnly = isFirst && !seeMore.nextSibling
      const insertPosition = isFirst ? 'beforeBegin' : 'afterEnd'
      parentNode.insertAdjacentElement(insertPosition, seeMore)
      if (isOnly) {
        parentNode.remove()
      }
      return restoreSeeMore(el.innerHTML)
    }
    seeMore.replaceWith('\{\{seeMore}}')
    return el.innerHTML
  }

  let editMode = false
  let unsavedChanges = {}

  document.body.appendChild(editorElement)
  document.title = (() => {
    var el = document.createElement('div')
    el.innerHTML = document.title
    return el.innerText
  })()

  query('#rebuild-btn').addEventListener('click', () => {
    rebuild()
  })

  query('#save-btn').addEventListener('click', async () => {
    console.log('changes', unsavedChanges)
    Object.keys(unsavedChanges).forEach(async (filePath) => {
        const change = unsavedChanges[filePath]
        if (!change) {
          return
        }
        if (change.content) {
          await Post.updateContent(filePath, restoreSeeMore(change.content))
        }
        if (change.title) {
          await Post.updateTitle(filePath, change.title, change.foldered)
        }
    })
  })

  query('#edit-mode').addEventListener('change', (e) => {
    document.body.classList.toggle('edit-mode')
    editMode = !editMode
    editables.forEach(editable => {
      editable.contentEditable = e.target.checked
    })
  })

  const editables = Array.from(queryAll('[data-editable="true"]'))
  const originals = editables.map(e => ({
    path:
      e.dataset.section === 'summary' ?
      findParent(e, '[data-section="content"]').dataset.path :
      e.dataset.path,
    content: e.innerHTML
  }))

  editables.forEach(editable => {
    let { section, path, foldered } = editable.dataset
    if (section === 'summary') {
      path = findParent(editable, '[data-section="content"]').dataset.path
    }
    const originalContent = originals.find(c => c.path === path).content

    editable.addEventListener('input', (e) => {
      const isSameContent = originalContent === editable.innerHTML
      if (isSameContent) {
        const otherChanges = omit(omit(unsavedChanges[path], section), 'foldered')
        if (Object.keys(otherChanges).length) {
          unsavedChanges[path] = otherChanges
        } else {
          unsavedChanges = omit(unsavedChanges, path)
        }
      } else {
        unsavedChanges[path] = {
          ...unsavedChanges[path],
          [section]: editable.innerHTML.trim(),
          foldered: foldered === 'true' || foldered === true
        }
      }
      unsavedChangesList.innerHTML = Object.keys(unsavedChanges).map(path => `
        ${Object.keys(unsavedChanges[path]).map(key => `
          <li>${path} (${unsavedChanges[path][key]})</li>
        `)}
      `).join('')
      editorElement.classList.toggle('unsaved', Object.keys(unsavedChanges).length)
    })

    editable.addEventListener('click', e => {
      if (editMode && findParent(editable, 'a')) {
        e.preventDefault()
      }
    })
  })
</script>
